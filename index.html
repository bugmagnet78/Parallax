<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>WebXR + MediaPipe Objectron (Init Test)</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
        background-color: #000;
        color: white;
      }
      #info {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display: block;
        color: white;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        font-size: 16px;
        box-sizing: border-box;
        min-height: 3em;
      }
      .button-container {
        position: absolute;
        bottom: 30px;
        width: 100%;
        text-align: center;
        z-index: 101;
      }
      .button-container button {
        padding: 12px 24px;
        font-size: 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s ease;
      }
      .button-container button:disabled {
        background-color: #555;
        color: #aaa;
        cursor: not-allowed;
        box-shadow: none;
      }
      .button-container button:hover:not(:disabled) {
        background-color: #0056b3;
      }
      canvas#webgl-canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      video#input-video {
        display: none;
      } /* Hide the video element */
    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.163.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/"
        }
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/objectron/objectron.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="info">Initializing...</div>
    <div class="button-container">
      <button id="start-ar-button" disabled>Start AR Objectron</button>
    </div>
    <video id="input-video"></video>
    <canvas id="webgl-canvas"></canvas>

    <script type="module">
      console.log(
        '--- JavaScript module execution started (Objectron Init Test) ---'
      );

      import * as THREE from 'three';

      console.log('Three.js imported:', THREE ? 'Yes' : 'No');
      console.log(
        'MediaPipe Objectron available:',
        window.Objectron ? 'Yes' : 'No'
      );

      // --- Relevant Context ---
      // Current time: Sunday, March 30, 2025 at 4:02 PM
      // Location: Kochi, Kerala, India

      // Global variables
      let camera, scene, renderer; // Three.js
      let currentSession = null; // WebXR
      let referenceSpace = null;
      let objectron = null; // MediaPipe
      let cameraHelper = null; // MediaPipe Camera Util
      let latestObjectronResult = null; // Store detection result
      let objectronBoundingBox = null; // Three.js Box Helper

      const infoDivElement = document.getElementById('info');
      const startButtonElement = document.getElementById('start-ar-button');
      const videoElement = document.getElementById('input-video');
      const canvasElement = document.getElementById('webgl-canvas');

      // --- Function Definitions (Defined ONCE Each) ---

      async function init() {
        console.log('init() called');
        // --- Element Checks ---
        if (
          !infoDivElement ||
          !startButtonElement ||
          !canvasElement ||
          !videoElement ||
          !window.Objectron
        ) {
          console.error(
            'FATAL: UI/Canvas/Video/Objectron missing or MP not loaded.'
          );
          if (infoDivElement)
            infoDivElement.textContent =
              'Error: Required elements or MediaPipe Objectron not loaded.';
          if (startButtonElement) startButtonElement.disabled = true;
          return; // OK
        }

        // --- Three.js Setup (Still needed for potential context later, but minimal) ---
        infoDivElement.textContent = 'Setting up Scene & Renderer...';
        try {
          scene = new THREE.Scene(); // Keep scene for potential future use
          camera = new THREE.PerspectiveCamera(
            70,
            window.innerWidth / window.innerHeight,
            0.01,
            40
          ); // Keep camera
          // Keep renderer setup in case needed later, but XR part isn't used in this test path
          renderer = new THREE.WebGLRenderer({
            canvas: canvasElement,
            antialias: true,
            alpha: true,
          });
          renderer.setPixelRatio(window.devicePixelRatio);
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.xr.enabled = true; // Keep enabled, though session isn't linked yet in this test
          console.log('Three.js Renderer initialized, XR enabled.');
          // Skip adding lights/box helper for this specific init test
        } catch (error) {
          console.error('Init Error (Three.js):', error);
          displayCompatibilityError('3D Setup failed: ' + error.message);
          return; // OK
        }

        // --- MediaPipe Objectron Initialization Test ---
        infoDivElement.textContent = 'Loading Objectron Model...';
        try {
          console.log('Attempting: new Objectron(...)');
          objectron = new Objectron({
            locateFile: (file) => {
              // Always return the base path for the legacy package
              const basePath =
                'https://cdn.jsdelivr.net/npm/@mediapipe/objectron@0.4/';
              console.log(`Locating file: ${file} -> ${basePath}${file}`);
              return `${basePath}${file}`;
            },
          });
          // Check if objectron object was created successfully
          if (!objectron) {
            throw new Error(
              'Objectron instance is null/undefined after constructor call.'
            );
          }
          console.log('Objectron instance seemingly created:', objectron); // Log the created object

          // --- TEMPORARILY COMMENT OUT setOptions ---
          console.log('Skipping objectron.setOptions() for this test.');
          /*
                objectron.setOptions({
                    staticImageMode: false,
                    modelName: 'Shoe', // Or 'Chair', 'Cup', 'Camera'
                    maxNumObjects: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.7,
                });
                console.log("Objectron options seemingly set.");
                */

          // --- Set callback (Try this even if options skipped) ---
          console.log('Attempting: objectron.onResults(...)');
          objectron.onResults(onObjectronResults);
          console.log('Objectron results callback set.');

          // --- Stop here for the test ---
          infoDivElement.textContent =
            'Objectron Init Test Complete. Check Console for errors.';
          console.log(
            'Objectron initialization test finished. Camera/WebXR steps were skipped.'
          );
          startButtonElement.disabled = true; // Keep disabled as flow is stopped
        } catch (error) {
          // Catch errors specifically during Objectron instantiation or onResults setup
          console.error('MediaPipe Init/Setup Error:', error);
          displayCompatibilityError('MediaPipe setup failed: ' + error.message);
          return; // OK
        }

        // --- Skip Camera and WebXR Check ---
        // console.log("Skipping Camera setup for Objectron init test.");
        // console.log("Skipping WebXR check for Objectron init test.");
        // window.addEventListener('resize', onWindowResize, false); // Can skip this too
      } // --- End of init function ---

      // --- Placeholder/Empty Function Definitions ---
      // Define other functions so script doesn't break, but they won't be called in this test flow
      function onObjectronResults(results) {
        console.log(
          'onObjectronResults received (should not happen in this init test)',
          results
        );
      }
      async function checkXRSupport() {
        console.warn('checkXRSupport skipped in init test');
      }
      function displayCompatibilityError(message) {
        console.error('Compat Error:', message);
        if (startButtonElement) startButtonElement.disabled = true;
        if (infoDivElement) infoDivElement.textContent = message;
      }
      function handleStartButtonClick() {
        console.warn('handleStartButtonClick skipped in init test');
      }
      async function startARSession() {
        console.warn('startARSession skipped in init test');
      }
      async function onSessionStarted(session) {
        console.warn('onSessionStarted skipped in init test');
      }
      function onSessionEnded(/*event*/) {
        console.warn('onSessionEnded skipped in init test');
      }
      function onWindowResize() {
        console.warn('onWindowResize skipped in init test');
      }
      function onXRFrame(timestamp, frame) {
        console.warn('onXRFrame skipped in init test');
      }

      // --- Start the application ---
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Ready.');
        init();
      });
      console.log('--- JS module execution finished (Objectron Init Test) ---');
    </script>
  </body>
</html>
